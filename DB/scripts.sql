
-- This syntax will create the new DB

   CREATE DATABASE IF NOT EXISTS GRATLYDB;


-- This table is the first table created after customer is onboarded

    CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_ONBOARDING (
         RESTAURANTID INT AUTO_INCREMENT PRIMARY KEY,
         RESTAURANTGUID VARCHAR(36) NOT NULL,
         SECRETKEY VARCHAR(64) NOT NULL,
         CLIENTSECRET VARCHAR(128) NOT NULL,
         USERACCESSTYPE VARCHAR(64) NOT NULL
     );

ALTER TABLE GRATLYDB.SRC_ONBOARDING AUTO_INCREMENT = 100;

INSERT INTO GRATLYDB.SRC_ONBOARDING(RESTAURANTGUID ,SECRETKEY, CLIENTSECRET, USERACCESSTYPE) values('0169bd32-becf-4b04-9093-d7d4db1dc242','WZ8mobWCpK4AcXQjDHgZcgQIMOCaQ3xs','XsplfAXitqH1ePen0nkEWV_lFuCEaabjEPhpagi_zLlKxDVdIrPdwhWJgj0W2o2v','TOAST_MACHINE_CLIENT');

-- This script will store the details of the restaurant(s) and is a source table

  CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_RESTAURANTDETAILS(
        RESTAURANTGUID VARCHAR(36) PRIMARY KEY,
        RESTAURANTNAME VARCHAR(128) NOT NULL,
        LOCATIONNAME VARCHAR(128),
        LOCATIONCODE VARCHAR(64),
        DESCRIPTION VARCHAR(128),
        TIMEZONE VARCHAR(128),
        CURRENCYCODE VARCHAR(32),
        FIRSTBUSINESSDATE VARCHAR(16),
        ARCHIVED VARCHAR(8),
        ADDRESS1 VARCHAR(256),
        ADDRESS2 VARCHAR(256),
        CITY VARCHAR(32),
        STATECODE VARCHAR(16),
        ZIPCODE VARCHAR(8),
        COUNTRY VARCHAR(32),
        PHONE VARCHAR(16),
        WEBSITE VARCHAR(512),
        ORDERONLINE VARCHAR(512)
  );




-- This script will store the details of all employees for all restaurants and is a source table

  CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_EMPLOYEES (
        RESTAURANTGUID VARCHAR(36) ,
        EMPLOYEEGUID VARCHAR(36) NOT NULL UNIQUE,
        EMPLOYEEFNAME VARCHAR(64),
        EMPLOYEELNAME VARCHAR(64),
        CHOSENNAME VARCHAR(64),
        PHONENUMBER VARCHAR(16),
        EMAIL VARCHAR(64),
        DELETED VARCHAR(8),
        DELETEDDATE DATE,
        PRIMARY KEY (RESTAURANTGUID, EMPLOYEEGUID),
        CONSTRAINT FK_RESGUIDEMP FOREIGN KEY(RESTAURANTGUID) REFERENCES  
        GRATLYDB.SRC_RESTAURANTDETAILS(RESTAURANTGUID)

    );
-- This table stores all different type of jobs for all the restaurants and is a source table

  CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_JOBS (
        RESTAURANTGUID VARCHAR(36),
        JOBGUID VARCHAR(36) NOT NULL UNIQUE,
        JOBTITLE VARCHAR(64),
        ENTITYTYPE VARCHAR(32),
        CREATEDDATE DATE,
        DELETED VARCHAR(8),
        DELETEDDATE DATE,
        CODE VARCHAR(36),
        TIPPED VARCHAR(8),
        DEFAULTWAGE VARCHAR(32),
        WAGEFREQUENCY VARCHAR(32),
        PRIMARY KEY (RESTAURANTGUID,JOBGUID),
        CONSTRAINT FK_RESGUIDJOB FOREIGN KEY(RESTAURANTGUID) REFERENCES  
        GRATLYDB.SRC_RESTAURANTDETAILS(RESTAURANTGUID)
        );


-- This table stores all roles assigned to an employee by the Restaurant and is a source table

  CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_EMPLOYEEROLE (
        RESTAURANTGUID VARCHAR(36),
        EMPLOYEEGUID VARCHAR(36),
        NAME VARCHAR(64),
        JOBGUID varchar(36),
        PRIMARY KEY(RESTAURANTGUID,EMPLOYEEGUID,JOBGUID),
        CONSTRAINT FK_RESGUIDEMPR FOREIGN KEY(RESTAURANTGUID) REFERENCES  
        GRATLYDB.SRC_RESTAURANTDETAILS(RESTAURANTGUID),
        CONSTRAINT FK_EMPGUID FOREIGN KEY(EMPLOYEEGUID) REFERENCES  
        GRATLYDB.SRC_EMPLOYEES(EMPLOYEEGUID),
        CONSTRAINT FK_JOBGUID FOREIGN KEY(JOBGUID) REFERENCES  
        GRATLYDB.SRC_JOBS(JOBGUID)
       );

-- This script stores all tables in the restaurant and is a source table

   CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_TABLES (
     RESTAURANTGUID VARCHAR(36),		
     TABLEGUID VARCHAR(36),
     ENTITYTYPE VARCHAR(16),
     TABLENAME VARCHAR(32),
     PRIMARY KEY(RESTAURANTGUID,TABLEGUID),
     CONSTRAINT FK_RESGUIDTAB FOREIGN KEY(RESTAURANTGUID) REFERENCES  
     GRATLYDB.SRC_RESTAURANTDETAILS(RESTAURANTGUID)
);

-- This table get all time entries for all employees for the current day and is a source table

   CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_TIMEENTRIES (
    RESTAURANTGUID VARCHAR(36),		
    TIMEENTRYGUID VARCHAR(36),
    ENTITYTYPE VARCHAR(50) NOT NULL,
    EXTERNALID VARCHAR(255),
    EMPLOYEEGUID VARCHAR(36),
    JOBID VARCHAR(36),
    SHIFTREFERENCE VARCHAR(36),
    INDATE VARCHAR(36),
    OUTDATE VARCHAR(36),
    BUSINESSDATE VARCHAR(12),
    REGULARHOURS DECIMAL(5,2) DEFAULT 0.00,
    OVERTIMEHOURS DECIMAL(5,2) DEFAULT 0.00,
    HOURLYWAGE DECIMAL(7,2),
    TIPSWITHHELD DECIMAL(7,2) DEFAULT 0.00,
    NONCASHSALES DECIMAL(10,2) DEFAULT 0.00,
    CASHSALES DECIMAL(10,2) DEFAULT 0.00,
    NONCASHGRATUITYSERVICECHARGES DECIMAL(10,2) DEFAULT 0.00,
    CASHGRATUITYSERVICECHARGES DECIMAL(10,2) DEFAULT 0.00,
    NONCASHTIPS DECIMAL(5,2),
    DECLAREDCASHTIPS DECIMAL(10,2),
    AUTOCLOCKEDOUT BOOLEAN DEFAULT FALSE,
    DELETED BOOLEAN DEFAULT FALSE,
    CREATEDDATE VARCHAR(36),
    MODIFIEDDATE VARCHAR(36),
    DELETEDDATE VARCHAR(36),
    PRIMARY KEY (RESTAURANTGUID,TIMEENTRYGUID),
    CONSTRAINT FK_RESGUIDTME FOREIGN KEY(RESTAURANTGUID) REFERENCES  
    GRATLYDB.SRC_RESTAURANTDETAILS(RESTAURANTGUID),
    CONSTRAINT FK_EMPGUIDTME FOREIGN KEY(EMPLOYEEGUID) REFERENCES  
    GRATLYDB.SRC_EMPLOYEES(EMPLOYEEGUID)
);

-- This table contains all orders for current day for all restaurants and is a source table

CREATE TABLE IF NOT EXISTS GRATLYDB.SRC_ALLORDERS (
    RESTAURANTGUID VARCHAR(36),
    ORDERGUID VARCHAR(36),
    DISPLAYNUMBER INT,
    BUSINESSDATE VARCHAR(12),
    ORDERSOURCE VARCHAR(64),
    TABLEGUID VARCHAR(36),
    ORDERPAIDDATE VARCHAR(36),
    VOIDED VARCHAR(8),
    OPENEDDATE VARCHAR(36),
    PREPTIME VARCHAR(32),
    PAYMENTTYPE VARCHAR(16),
    REFUNDSTATUS VARCHAR(16),
    PAYMENTSTATUS VARCHAR(16),
    NETAMOUNT DECIMAL(7,2),
    TIPAMOUNT DECIMAL(5,2),
    GRATUITYAMOUNT DECIMAL(5,2),
    TAXAMOUNT DECIMAL(7,2),
    TOTALAMOUNT DECIMAL(7,2),
    EMPLOYEEGUID VARCHAR(36),
    NUMBEROFGUESTS INT,
    DURATION BIGINT,
    APPROVALSTATUS VARCHAR(16),
    PRIMARY KEY (RESTAURANTGUID,ORDERGUID),
    CONSTRAINT FK_RESGUIDALO FOREIGN KEY(RESTAURANTGUID) REFERENCES  
    GRATLYDB.SRC_RESTAURANTDETAILS(RESTAURANTGUID),
    CONSTRAINT FK_EMPGUIDALO FOREIGN KEY(EMPLOYEEGUID) REFERENCES  
    GRATLYDB.SRC_EMPLOYEES(EMPLOYEEGUID)
); 

-- This Table stores user info from signup page for application and is a master table

CREATE TABLE IF NOT EXISTS GRATLYDB.USER_MASTER (
  USERID INT AUTO_INCREMENT PRIMARY KEY,
  FIRSTNAME VARCHAR(32) NOT NULL,
  LASTNAME VARCHAR(32) NOT NULL,
  EMAIL VARCHAR(64) NOT NULL UNIQUE,
  PHONENUMBER VARCHAR(32),
  PASSWORD_HASH VARCHAR(255) NOT NULL,
  USERSTATUS BOOLEAN,
  CREATEDAT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- This Table stores the association of the user to restaurant for all users 

CREATE TABLE IF NOT EXISTS GRATLYDB.USERRESTAURANT (
   USERRESTAURANTID INT AUTO_INCREMENT PRIMARY KEY,
   USERID INT,
   RESTAURANTID INT,
   CONSTRAINT FK_RESID FOREIGN KEY(RESTAURANTID) REFERENCES  
   GRATLYDB.SRC_ONBOARDING(RESTAURANTID),
   CONSTRAINT FK_USERID FOREIGN KEY(USERID) REFERENCES  
   GRATLYDB.USER_MASTER(USERID)
);

-- This Table stores the permissions for all users

CREATE TABLE IF NOT EXISTS GRATLYDB.USER_PERMISSIONS(
USERPERMISSIONSID INT AUTO_INCREMENT PRIMARY KEY, 
USERID INT,
ISADMIN BOOLEAN,
ISEMPLOYEE BOOLEAN,
ISCREATEPAYOUTSCHEDULE BOOLEAN,
ISAPPROVEPAYOUT BOOLEAN,
ISMANAGEEMPLOYEES BOOLEAN,
CREATEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
MODIFIEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT FK_USERID_UP FOREIGN KEY(USERID) REFERENCES  
   GRATLYDB.USER_MASTER(USERID)
);

-- Below tables will store ALL values for Payout Schedule created for each restaurant

CREATE TABLE IF NOT EXISTS GRATLYDB.PAYOUT_SCHEDULE (
PAYOUT_SCHEDULEID INT AUTO_INCREMENT PRIMARY KEY,
RESTAURANTID INT NOT NULL,
USERID INT NOT NULL,
NAME VARCHAR(128) NOT NULL,
START_DAY VARCHAR(8),
END_DAY VARCHAR(8),
START_TIME VARCHAR(8),
END_TIME VARCHAR(8),
PAYOUTTRIGGER_GRATUITY FLOAT,
PAYOUTTRIGGER_TIPS FLOAT,
PAYOUT_RULE_ID VARCHAR(64) NOT NULL, -- 1 - CUSTOM PAYOUT, 2 - EQUAL PAYOUT, 3 - HOUR BASED PAYOUT, 4 - JOB WEIGHTED PAYOUT
PREPAYOUT_FLAG BOOLEAN,              -- 1 - VALUE EXISTS FOR PRE_PAYOUT, 0 - NO VALUE FOR PREPAYOUT
CREATEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
MODIFIEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
CONSTRAINT FK_PAYOUT_RESTAURANTID FOREIGN KEY(RESTAURANTID) REFERENCES GRATLYDB.SRC_ONBOARDING(RESTAURANTID),
CONSTRAINT FK_PAYOUT_USERID FOREIGN KEY(USERID) REFERENCES GRATLYDB.USER_MASTER(USERID)
);



CREATE TABLE IF NOT EXISTS GRATLYDB.PAYOUTRECEIVERS (
PAYOUTRECEIVERSID INT AUTO_INCREMENT PRIMARY KEY,
PAYOUT_SCHEDULEID INT,
PAYOUT_RULE_ID VARCHAR(64),
CONTRIBUTOR_RECIEVER BOOLEAN,
PAYOUT_RECEIVERID VARCHAR(36),
PAYOUT_PERCENTAGE FLOAT,
CREATEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
MODIFIEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
CONSTRAINT FK_PAYOUT_SCHEDULEID FOREIGN KEY(PAYOUT_SCHEDULEID) REFERENCES GRATLYDB.PAYOUT_SCHEDULE(PAYOUT_SCHEDULEID)
);


CREATE TABLE IF NOT EXISTS GRATLYDB.PAYOUT_CUSTOM (
PAYOUT_CUSTOMID  INT AUTO_INCREMENT PRIMARY KEY,
PAYOUT_SCHEDULEID INT,
INDIVIDUAL_PAYOUT FLOAT,
GROUPCONTRIBUTION FLOAT,
CREATEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
MODIFIEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
CONSTRAINT FK_PAYOUT_SCHEDULEID_PC FOREIGN KEY(PAYOUT_SCHEDULEID) REFERENCES GRATLYDB.PAYOUT_SCHEDULE(PAYOUT_SCHEDULEID)
);

CREATE TABLE IF NOT EXISTS GRATLYDB.PREPAYOUT (
PREPAYOUTID INT AUTO_INCREMENT PRIMARY KEY,
PAYOUT_SCHEDULEID INT,
PREPAYOUTOPTION BOOLEAN, -- 0 MEANS PERCENTAGE AND 1 MEANS FIXED AMOUNT
PREPAYOUT_VALUE FLOAT,
USERACCOUNT VARCHAR(36),
CREATEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
MODIFIEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
CONSTRAINT FK_PAYOUT_SCHEDULEID_PP FOREIGN KEY(PAYOUT_SCHEDULEID) REFERENCES GRATLYDB.PAYOUT_SCHEDULE(PAYOUT_SCHEDULEID)
);

CREATE TABLE IF NOT EXISTS GRATLYDB.EMAIL_INVITES (
INVITEID INT AUTO_INCREMENT PRIMARY KEY,
USERID INT NOT NULL,
EMPLOYEEGUID VARCHAR(64),
EMAIL VARCHAR(128) NOT NULL,
FIRSTNAME VARCHAR(64),
LASTNAME VARCHAR(64),
STATUS VARCHAR(32) NOT NULL,
PROVIDER VARCHAR(32),
PROVIDER_RESPONSE TEXT,
CREATEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
MODIFIEDDATE DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
INDEX IDX_EMAIL_INVITES_USERID (USERID),
INDEX IDX_EMAIL_INVITES_EMAIL (EMAIL),
CONSTRAINT FK_EMAIL_INVITES_USERID FOREIGN KEY(USERID) REFERENCES GRATLYDB.USER_MASTER(USERID)
);
